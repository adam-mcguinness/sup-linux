#!/bin/bash
# PAM wrapper for LinuxSup face authentication
# This script is called by pam_exec.so and sets up the environment properly

# Export PAM variables for the authentication binary
export PAM_USER="${PAM_USER}"
export PAM_SERVICE="${PAM_SERVICE}"
export PAM_TTY="${PAM_TTY}"
export PAM_RHOST="${PAM_RHOST}"
export PAM_TYPE="${PAM_TYPE}"

# Log the attempt
logger -t linuxsup-pam "Face auth attempt for user=$PAM_USER service=$PAM_SERVICE tty=$PAM_TTY"

# Ensure we have access to video devices
# The user running this needs to be in the video group
if [ -e /dev/video0 ] || [ -e /dev/video51 ] || [ -e /dev/video52 ]; then
    # Run the actual authentication
    /usr/local/bin/linuxsup-auth
    RESULT=$?
else
    logger -t linuxsup-pam "No video device found, skipping face auth"
    # No camera, fail face auth (PAM will fall back to next method)
    exit 1
fi

# Log the result
if [ $RESULT -eq 0 ]; then
    logger -t linuxsup-pam "Face auth successful for user=$PAM_USER"
else
    logger -t linuxsup-pam "Face auth failed for user=$PAM_USER"
fi

exit $RESULT